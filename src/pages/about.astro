---
import { Image } from "astro:assets";
import type { ImageMetadata } from "astro";
import Container from "@components/Container.astro";
import PageLayout from "@layouts/PageLayout.astro";
import RichText from "@components/RichText.astro";
import SectionHeading from "@components/SectionHeading.astro";
import Timeline from "@components/Timeline.astro";
import { ABOUT } from "@consts";
import { about } from "@i18n/en";
import type { RichTextLink } from "@i18n/en";
import portrait from "@assets/portrait.jpeg";

const coverImages = import.meta.glob<{ default: ImageMetadata }>(
  "/src/assets/releases/*.jpg",
  { eager: true },
);

function getCover(slug: string): ImageMetadata | undefined {
  return coverImages[`/src/assets/releases/${slug}.jpg`]?.default;
}

function getStreamingUrl(
  segments: (string | RichTextLink)[],
): string | undefined {
  const link = segments.find(
    (segment): segment is RichTextLink => typeof segment !== "string",
  );
  return link?.href;
}
---

<PageLayout title={ABOUT.TITLE} description={ABOUT.DESCRIPTION}>
  <Container>
    <div class="space-y-8 sm:space-y-10">
      <section
        class="animate text-center sm:text-left after:block after:clear-both after:content-['']"
      >
        <div
          class="mx-auto mb-6 w-36 h-36 sm:mx-0 sm:mb-6 sm:mr-10 sm:float-left sm:w-44 sm:h-44 sm:rounded-br-[4.5rem] [shape-outside:margin-box]"
        >
          <Image
            src={portrait}
            alt={about.portraitAlt}
            width={176}
            height={176}
            loading="eager"
            class="w-36 h-36 sm:w-44 sm:h-44 rounded-full object-cover"
          />
        </div>
        <p>
          <RichText segments={about.intro} />
        </p>
        <p class="mt-4">
          <RichText segments={about.currentWork} />
        </p>
      </section>

      <section class="animate space-y-4">
        <SectionHeading color="accent"
          >{about.sections.experience}</SectionHeading
        >
        <Timeline entries={about.experience} />
      </section>

      <section class="animate space-y-4">
        <SectionHeading color="cyan">{about.sections.privacy}</SectionHeading>
        <p>
          <RichText segments={about.privacy} />
        </p>
      </section>

      <section class="animate space-y-4">
        <SectionHeading color="warm">{about.sections.music}</SectionHeading>
        <p>
          <RichText segments={about.music} />
        </p>
      </section>

      <section class="animate space-y-4">
        <SectionHeading color="green">{about.sections.releases}</SectionHeading>
        <p>{about.sections.releasesIntro}</p>
        <ul class="space-y-3">
          {
            about.releases.map((entry) => {
              const cover = getCover(entry.cover);
              const streamingUrl = getStreamingUrl(entry.segments);
              return (
                <li class="flex items-start gap-3">
                  <span class="font-mono text-sm text-tn-light-fg-muted/50 dark:text-tn-dark-fg-muted/50 shrink-0 w-10 text-right pt-1">
                    {entry.year}
                  </span>
                  {cover && streamingUrl ? (
                    <a
                      href={streamingUrl}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="shrink-0"
                    >
                      <Image
                        src={cover}
                        alt={`Cover art`}
                        width={40}
                        height={40}
                        class="rounded size-10 object-cover"
                      />
                    </a>
                  ) : cover ? (
                    <Image
                      src={cover}
                      alt={`Cover art`}
                      width={40}
                      height={40}
                      class="rounded size-10 object-cover shrink-0"
                    />
                  ) : null}
                  <span class="text-sm pt-0.5">
                    <RichText segments={entry.segments} />
                  </span>
                </li>
              );
            })
          }
        </ul>
      </section>
    </div>
  </Container>
</PageLayout>
